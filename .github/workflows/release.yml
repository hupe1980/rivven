name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  CARGO_TERM_COLOR: always

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      # Cache only registry, not target (avoids incremental bloat)
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      # Run unit tests only (integration tests already passed in CI)
      - name: Run tests
        run: cargo test --release --workspace --lib --bins
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  publish:
    name: Publish to crates.io
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      
      # ============================================================
      # Publish crates in STRICT dependency order
      # ============================================================
      
      # Layer 1: No internal dependencies
      - name: Publish rivven-core
        run: cargo publish -p rivven-core --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true  # Skip if already published
      
      - name: Publish rivven-connect-derive
        run: cargo publish -p rivven-connect-derive --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Publish rivven-protocol
        run: cargo publish -p rivven-protocol --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 2: Depends only on rivven-core
      - name: Publish rivven-cluster
        run: cargo publish -p rivven-cluster --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Publish rivven-cdc
        run: cargo publish -p rivven-cdc --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 3: Depends on core + protocol
      - name: Publish rivven-client
        run: cargo publish -p rivven-client --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 4: Depends on protocol, core (optional), client (optional)
      - name: Publish rivven-schema
        run: cargo publish -p rivven-schema --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 5: rivvend depends on core, protocol, cluster
      - name: Publish rivvend
        run: cargo publish -p rivvend --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 6: rivven-connect depends on cdc, core, client, schema, connect-derive
      - name: Publish rivven-connect
        run: cargo publish -p rivven-connect --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Wait for crates.io index
        run: sleep 30
      
      # Layer 7: Final binaries
      - name: Publish rivven (CLI)
        run: cargo publish -p rivven --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true
      
      - name: Publish rivven-operator
        run: cargo publish -p rivven-operator --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true

  pypi:
    name: Publish to PyPI (${{ matrix.target }})
    needs: validate
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: auto
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            manylinux: 2_28
            container: messense/manylinux_2_28-cross:aarch64
          - os: macos-latest
            target: aarch64-apple-darwin
            manylinux: 'off'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      # Clean any cached builds to ensure fresh version
      - name: Clean previous builds
        run: cargo clean -p rivven-python 2>/dev/null || true
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python3.12 --manifest-path crates/rivven-python/Cargo.toml
          sccache: 'false'  # Disable sccache for releases to ensure fresh builds
          manylinux: ${{ matrix.manylinux }}
          container: ${{ matrix.container || '' }}
          before-script-linux: |
            # Install required build dependencies for vendored OpenSSL
            yum install -y perl-IPC-Cmd perl-FindBin perl-File-Compare perl-File-Copy 2>/dev/null || \
            apt-get update && apt-get install -y perl make 2>/dev/null || true
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.target }}
          path: dist
          retention-days: 7

  pypi-publish:
    name: Publish to PyPI
    needs: pypi
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: pypi
      url: https://pypi.org/p/rivven
    permissions:
      id-token: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true  # Don't fail if version already exists

  release:
    name: Create GitHub Release
    needs: [publish, pypi-publish, docker, binaries]
    # Run even if publish jobs fail (version may already exist)
    if: always() && needs.binaries.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-*
          path: binaries
      
      - name: Create tarballs for release
        run: |
          mkdir -p release
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Process each platform's binaries
          for dir in binaries/binaries-*/; do
            # Extract suffix from directory name (e.g., binaries-linux-amd64 -> linux-amd64)
            suffix=$(basename "$dir" | sed 's/binaries-//')
            
            # Find and package each binary
            for bin in rivvend rivven rivven-connect rivven-operator rivven-schema; do
              # Find the binary (may be nested in target/*/release/)
              binary=$(find "$dir" -name "$bin" -type f | head -1)
              if [ -n "$binary" ]; then
                tar -czvf "release/${bin}-${VERSION}-${suffix}.tar.gz" -C "$(dirname "$binary")" "$bin"
              fi
            done
          done
          
          echo "=== Release artifacts ==="
          ls -la release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Rivven v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release/*.tar.gz

  binaries:
    name: Build Binaries (${{ matrix.target }})
    needs: validate
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 - STATIC musl binary (works everywhere including Docker)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            suffix: linux-amd64
            cross: false
          # Linux arm64 - STATIC musl binary (native arm64 runner, no QEMU!)
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            suffix: linux-arm64
            cross: false
          # macOS Apple Silicon (dynamic, but that's normal for macOS)
          - os: macos-14
            target: aarch64-apple-darwin
            suffix: darwin-arm64
            cross: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install musl tools (Linux only)
        if: contains(matrix.target, 'musl')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      
      - name: Build static binaries
        run: |
          # For musl targets, enable static linking
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            export RUSTFLAGS="-C target-feature=+crt-static"
          fi
          
          cargo build --release --target ${{ matrix.target }} \
            --package rivvend \
            --package rivven \
            --package rivven-connect \
            --package rivven-operator \
            --package rivven-schema
      
      - name: Verify static linking (Linux only)
        if: contains(matrix.target, 'musl')
        run: |
          echo "Checking binary linkage..."
          file target/${{ matrix.target }}/release/rivvend
          # Verify it's statically linked (should say "statically linked")
          file target/${{ matrix.target }}/release/rivvend | grep -i static || echo "Warning: may not be fully static"
      
      # Upload raw binaries (single artifact per platform)
      # Used by both docker job (COPY) and release job (tarball)
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.suffix }}
          path: |
            target/${{ matrix.target }}/release/rivvend
            target/${{ matrix.target }}/release/rivven
            target/${{ matrix.target }}/release/rivven-connect
            target/${{ matrix.target }}/release/rivven-operator
            target/${{ matrix.target }}/release/rivven-schema
          retention-days: 7

  docker:
    name: Build & Push Docker Images
    needs: [validate, binaries]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      # Download pre-built static binaries from binaries job
      - name: Download amd64 binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-amd64
          path: raw-amd64
      
      - name: Download arm64 binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-arm64
          path: raw-arm64
      
      - name: Prepare binaries for Docker
        run: |
          # Create directory structure expected by Dockerfile
          mkdir -p binaries/amd64 binaries/arm64
          
          # Move binaries to correct locations (artifacts may have nested paths)
          for bin in rivvend rivven rivven-connect rivven-operator rivven-schema; do
            find raw-amd64 -name "$bin" -type f -exec cp {} binaries/amd64/ \;
            find raw-arm64 -name "$bin" -type f -exec cp {} binaries/arm64/ \;
          done
          
          # Make binaries executable
          chmod +x binaries/amd64/* binaries/arm64/*
          
          # Verify
          echo "=== AMD64 binaries ==="
          ls -la binaries/amd64/
          file binaries/amd64/rivvend
          
          echo "=== ARM64 binaries ==="
          ls -la binaries/arm64/
          file binaries/arm64/rivvend
      
      # QEMU is still needed for buildx to create multi-arch manifests,
      # but no actual emulation happens since binaries are pre-built
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push rivvend (broker)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: BINARY=rivvend
          tags: |
            ghcr.io/${{ github.repository_owner }}/rivvend:latest
            ghcr.io/${{ github.repository_owner }}/rivvend:${{ steps.version.outputs.VERSION }}
      
      - name: Build and push rivven-connect
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: BINARY=rivven-connect
          tags: |
            ghcr.io/${{ github.repository_owner }}/rivven-connect:latest
            ghcr.io/${{ github.repository_owner }}/rivven-connect:${{ steps.version.outputs.VERSION }}
      
      - name: Build and push rivven-operator
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: BINARY=rivven-operator
          tags: |
            ghcr.io/${{ github.repository_owner }}/rivven-operator:latest
            ghcr.io/${{ github.repository_owner }}/rivven-operator:${{ steps.version.outputs.VERSION }}
      
      - name: Build and push rivven-schema
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: BINARY=rivven-schema
          tags: |
            ghcr.io/${{ github.repository_owner }}/rivven-schema:latest
            ghcr.io/${{ github.repository_owner }}/rivven-schema:${{ steps.version.outputs.VERSION }}
