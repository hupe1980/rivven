# Rivven Connect Configuration
# 
# Architecture:
#   Sources → publish to → Broker Topics
#   Broker Topics → consumed by → Sinks
#
# The broker is ALWAYS in the middle. This provides:
#   - Durability (events survive connector restarts)
#   - Replay (sinks can reprocess from any offset)
#   - Decoupling (sources and sinks are independent)
#   - Fan-out (multiple sinks can consume same topic)

version: "1.0"

# Broker connection (required)
broker:
  # Bootstrap servers (can be single or list for high availability)
  bootstrap_servers:
    - localhost:9092
  # TLS configuration (optional)
  tls:
    enabled: false
    # cert_path: /path/to/client.crt
    # key_path: /path/to/client.key
    # ca_path: /path/to/ca.crt
    # insecure: false

# Source connectors - read from external systems, publish to broker topics
sources:
  # PostgreSQL CDC source
  postgres_cdc:
    connector: postgres-cdc
    # Topic where events will be published
    topic: cdc.postgres.events
    # Connector-specific configuration
    config:
      host: localhost
      port: 5432
      database: testdb
      user: postgres
      password: ${POSTGRES_PASSWORD}  # Environment variable expansion
      slot_name: rivven_slot
      publication: rivven_pub
      # Per-table topic routing (enables dynamic topics based on CDC metadata)
      # Supports: {database}, {schema}, {table} placeholders
      topic_routing: "cdc.postgres.{schema}.{table}"
      # Events from public.users → cdc.postgres.public.users
      # Events from public.orders → cdc.postgres.public.orders
      # Which schemas and tables to capture (empty = all)
      schemas:
        - public
      tables:
        - users
        - orders

# Sink connectors - consume from broker topics, write to external systems
sinks:
  # S3 sink example
  s3_archive:
    connector: s3
    # Topics to consume (supports wildcards)
    topics:
      - cdc.postgres.*
    # Consumer group for offset tracking
    consumer_group: s3-archive-sink
    config:
      bucket: my-data-lake
      region: us-east-1
      prefix: raw/postgres/
      format: parquet
      # Batching for efficiency
      batch_size: 10000
      batch_timeout_ms: 60000

  # Stdout sink for debugging
  debug:
    connector: stdout
    topics:
      - cdc.postgres.events
    consumer_group: debug-sink
    config:
      format: pretty

# Global settings
settings:
  # State storage for connector offsets
  state_dir: ./data/connect-state
  # Metrics
  metrics:
    enabled: true
    port: 9091
  # Logging
  log_level: info
