# Rivven Connect Configuration
# 
# Architecture:
#   Sources → publish to → Broker Topics
#   Broker Topics → consumed by → Sinks
#
# The broker is ALWAYS in the middle. This provides:
#   - Durability (events survive connector restarts)
#   - Replay (sinks can reprocess from any offset)
#   - Decoupling (sources and sinks are independent)
#   - Fan-out (multiple sinks can consume same topic)

version: "1.0"

# Broker connection (required)
broker:
  # Bootstrap servers (can be single or list for high availability)
  bootstrap_servers:
    - localhost:9092
  # TLS configuration (optional)
  tls:
    enabled: false
    # cert_path: /path/to/client.crt
    # key_path: /path/to/client.key
    # ca_path: /path/to/ca.crt
    # insecure: false

# Source connectors - read from external systems, publish to broker topics
sources:
  # PostgreSQL CDC source
  postgres_cdc:
    connector: postgres-cdc
    # Topic where events will be published
    topic: cdc.postgres.events
    # Connector-specific configuration
    config:
      host: localhost
      port: 5432
      database: testdb
      user: postgres
      password: ${POSTGRES_PASSWORD}  # Environment variable expansion
      slot_name: rivven_slot
      publication: rivven_pub
      # Per-table topic routing (enables dynamic topics based on CDC metadata)
      # Supports: {database}, {schema}, {table} placeholders
      topic_routing: "cdc.postgres.{schema}.{table}"
      # Events from public.users → cdc.postgres.public.users
      # Events from public.orders → cdc.postgres.public.orders
      # Which schemas and tables to capture (empty = all)
      schemas:
        - public
      tables:
        - users
        - orders
        - documents

      # Single Message Transforms (SMTs)
      # Transforms are applied in order. Use predicates to target specific tables.
      transforms:
        # Mask PII only for users table
        - type: mask_field
          name: mask_user_pii
          predicate:
            table: "users"
          config:
            fields: [ssn, credit_card, phone]

        # Convert timestamps for orders table
        - type: timestamp_converter
          predicate:
            table: "orders"
          config:
            fields: [created_at, updated_at, shipped_at]
            format: iso8601

        # Store large document blobs in S3 (insert/update only)
        - type: externalize_blob
          predicate:
            table: "documents"
            operations: [insert, update]
          config:
            storage_type: s3
            bucket: ${BLOB_BUCKET}
            region: ${AWS_REGION}
            size_threshold: 100000
            prefix: cdc-blobs

        # Add processing metadata to all events (no predicate = all tables)
        - type: insert_field
          config:
            fields:
              _processed_by: "rivven-connect"
              _pipeline: "postgres-cdc-v1"

        # Flatten to top-level for all tables
        - type: extract_new_record_state
          config:
            add_table: true
            add_op: true
            add_ts: true

# Sink connectors - consume from broker topics, write to external systems
sinks:
  # S3 sink example
  s3_archive:
    connector: s3
    # Topics to consume (supports wildcards)
    topics:
      - cdc.postgres.*
    # Consumer group for offset tracking
    consumer_group: s3-archive-sink
    config:
      bucket: my-data-lake
      region: us-east-1
      prefix: raw/postgres/
      format: parquet
      # Batching for efficiency
      batch_size: 10000
      batch_timeout_ms: 60000

  # Stdout sink for debugging
  debug:
    connector: stdout
    topics:
      - cdc.postgres.events
    consumer_group: debug-sink
    config:
      format: pretty

# Global settings
settings:
  # State storage for connector offsets
  state_dir: ./data/connect-state
  # Metrics
  metrics:
    enabled: true
    port: 9091
  # Logging
  log_level: info
