syntax = "proto3";

package rivven.protocol.v1;

// Wire format definition for Rivven protocol.
// Client implementers can override package options when generating code:
//   protoc --go_out=. --go_opt=Mrivven.proto=your/package rivven.proto
//   protoc --java_out=. --java_opt=java_package=your.package rivven.proto

// ============================================================================
// Common Types
// ============================================================================

// Message header for all requests/responses
message Header {
  // Protocol version (must be 1)
  uint32 version = 1;
  // Correlation ID for request/response matching
  uint64 correlation_id = 2;
  // Optional client ID for tracking
  string client_id = 3;
}

// Record key-value pair
message Record {
  // Optional record key for partitioning
  bytes key = 1;
  // Record value (payload)
  bytes value = 2;
  // Optional headers
  repeated RecordHeader headers = 3;
  // Timestamp (milliseconds since epoch, 0 = server-assigned)
  int64 timestamp = 4;
}

// Record header (key-value metadata)
message RecordHeader {
  string key = 1;
  bytes value = 2;
}

// ============================================================================
// Requests
// ============================================================================

// Wrapper for all request types
message Request {
  Header header = 1;
  oneof request_type {
    PublishRequest publish = 10;
    ConsumeRequest consume = 11;
    CreateTopicRequest create_topic = 12;
    DeleteTopicRequest delete_topic = 13;
    ListTopicsRequest list_topics = 14;
    GetMetadataRequest get_metadata = 15;
    CommitOffsetRequest commit_offset = 16;
    GetOffsetRequest get_offset = 17;
    AuthenticateRequest authenticate = 20;
    PingRequest ping = 30;
    // Extended request types
    GetClusterMetadataRequest get_cluster_metadata = 31;
    GetOffsetBoundsRequest get_offset_bounds = 32;
    ListGroupsRequest list_groups = 33;
    DescribeGroupRequest describe_group = 34;
    DeleteGroupRequest delete_group = 35;
    GetOffsetForTimestampRequest get_offset_for_timestamp = 36;
    InitProducerIdRequest init_producer_id = 40;
    IdempotentPublishRequest idempotent_publish = 41;
    BeginTransactionRequest begin_transaction = 50;
    CommitTransactionRequest commit_transaction = 51;
    AbortTransactionRequest abort_transaction = 52;
    AlterTopicConfigRequest alter_topic_config = 60;
    DescribeTopicConfigsRequest describe_topic_configs = 61;
    CreatePartitionsRequest create_partitions = 62;
    DeleteRecordsRequest delete_records = 63;
    // SCRAM challenge messages
    ScramClientFirstRequest scram_client_first = 70;
    ScramClientFinalRequest scram_client_final = 71;
    // Transaction extension
    TransactionalPublishRequest transactional_publish = 53;
    AddPartitionsToTxnRequest add_partitions_to_txn = 54;
    AddOffsetsToTxnRequest add_offsets_to_txn = 55;
    // Quotas
    DescribeQuotasRequest describe_quotas = 80;
    AlterQuotasRequest alter_quotas = 81;
    // Handshake
    HandshakeRequest handshake = 90;
  }
}

// Publish a message to a topic
message PublishRequest {
  // Topic name
  string topic = 1;
  // Optional partition (if not set, computed from key or round-robin)
  optional uint32 partition = 2;
  // Record to publish
  Record record = 3;
}

// Batch publish multiple messages
message BatchPublishRequest {
  // Topic name
  string topic = 1;
  // Records to publish
  repeated PartitionRecords partition_records = 2;
  // Required acks: 0 = none, 1 = leader, -1 = all ISR
  int32 acks = 3;
  // Timeout in milliseconds
  uint32 timeout_ms = 4;
}

// Records for a single partition
message PartitionRecords {
  uint32 partition = 1;
  repeated Record records = 2;
}

// Consume messages from a topic partition
message ConsumeRequest {
  // Topic name
  string topic = 1;
  // Partition to consume from
  uint32 partition = 2;
  // Starting offset
  uint64 offset = 3;
  // Maximum number of messages to return
  uint32 max_messages = 4;
  // Maximum bytes to return (0 = no limit)
  uint64 max_bytes = 5;
  // Isolation level: 0 = read_uncommitted, 1 = read_committed
  uint32 isolation_level = 6;
}

// Create a new topic
message CreateTopicRequest {
  // Topic name
  string name = 1;
  // Number of partitions (0 = use server default)
  uint32 partitions = 2;
  // Replication factor (0 = use server default)
  uint32 replication_factor = 3;
  // Topic configuration
  map<string, string> config = 4;
}

// Delete a topic
message DeleteTopicRequest {
  string name = 1;
}

// List all topics
message ListTopicsRequest {
  // Optional prefix filter
  string prefix = 1;
}

// Get topic metadata
message GetMetadataRequest {
  // Topic names (empty = all topics)
  repeated string topics = 1;
}

// Commit consumer group offset
message CommitOffsetRequest {
  string consumer_group = 1;
  string topic = 2;
  uint32 partition = 3;
  uint64 offset = 4;
  // Optional metadata
  string metadata = 5;
}

// Get consumer group offset
message GetOffsetRequest {
  string consumer_group = 1;
  string topic = 2;
  uint32 partition = 3;
}

// Authenticate with the server
message AuthenticateRequest {
  // Authentication mechanism
  oneof mechanism {
    PlainAuth plain = 1;
    ScramAuth scram = 2;
  }
}

message PlainAuth {
  string username = 1;
  string password = 2;
}

message ScramAuth {
  // SCRAM mechanism: "SCRAM-SHA-256" or "SCRAM-SHA-512"
  string mechanism = 1;
  // Client-first message (base64 encoded)
  bytes client_first = 2;
}

// Ping/health check
message PingRequest {}

// ============================================================================
// Responses
// ============================================================================

// Wrapper for all response types
message Response {
  Header header = 1;
  oneof response_type {
    PublishResponse publish = 10;
    ConsumeResponse consume = 11;
    CreateTopicResponse create_topic = 12;
    DeleteTopicResponse delete_topic = 13;
    ListTopicsResponse list_topics = 14;
    GetMetadataResponse get_metadata = 15;
    CommitOffsetResponse commit_offset = 16;
    GetOffsetResponse get_offset = 17;
    AuthenticateResponse authenticate = 20;
    PingResponse ping = 30;
    ErrorResponse error = 99;
    // Extended response types
    GetClusterMetadataResponse get_cluster_metadata = 31;
    GetOffsetBoundsResponse get_offset_bounds = 32;
    ListGroupsResponse list_groups = 33;
    DescribeGroupResponse describe_group = 34;
    DeleteGroupResponse delete_group = 35;
    GetOffsetForTimestampResponse get_offset_for_timestamp = 36;
    InitProducerIdResponse init_producer_id = 40;
    IdempotentPublishResponse idempotent_publish = 41;
    BeginTransactionResponse begin_transaction = 50;
    CommitTransactionResponse commit_transaction = 51;
    AbortTransactionResponse abort_transaction = 52;
    AlterTopicConfigResponse alter_topic_config = 60;
    DescribeTopicConfigsResponse describe_topic_configs = 61;
    CreatePartitionsResponse create_partitions = 62;
    DeleteRecordsResponse delete_records = 63;
    OkResponse ok = 98;
    // SCRAM challenge responses
    ScramServerFirstResponse scram_server_first = 70;
    ScramServerFinalResponse scram_server_final = 71;
    // Transaction extension
    PartitionsAddedToTxnResponse partitions_added_to_txn = 53;
    TransactionalPublishResponse transactional_publish = 54;
    OffsetsAddedToTxnResponse offsets_added_to_txn = 55;
    // Quotas
    QuotasDescribedResponse quotas_described = 80;
    QuotasAlteredResponse quotas_altered = 81;
    ThrottledResponse throttled = 82;
    // Handshake
    HandshakeResultResponse handshake_result = 90;
  }
}

// Publish response
message PublishResponse {
  // Offset assigned to the message
  uint64 offset = 1;
  // Partition the message was written to
  uint32 partition = 2;
  // Server-assigned timestamp
  int64 timestamp = 3;
}

// Batch publish response
message BatchPublishResponse {
  repeated PartitionPublishResult results = 1;
}

message PartitionPublishResult {
  uint32 partition = 1;
  // Base offset for this partition's batch
  uint64 base_offset = 2;
  // Error code (0 = success)
  int32 error_code = 3;
  string error_message = 4;
}

// Consume response
message ConsumeResponse {
  // Messages consumed
  repeated ConsumedRecord records = 1;
  // High watermark (latest offset + 1)
  uint64 high_watermark = 2;
}

message ConsumedRecord {
  uint64 offset = 1;
  uint32 partition = 2;
  int64 timestamp = 3;
  bytes key = 4;
  bytes value = 5;
  repeated RecordHeader headers = 6;
}

// Create topic response
message CreateTopicResponse {
  // Name of the created topic
  string name = 1;
  // Number of partitions created
  uint32 partitions = 2;
}

// Delete topic response
message DeleteTopicResponse {}

// List topics response
message ListTopicsResponse {
  repeated string topics = 1;
}

// Get metadata response
message GetMetadataResponse {
  repeated TopicMetadata topics = 1;
  repeated BrokerInfo brokers = 2;
}

message TopicMetadata {
  string name = 1;
  repeated PartitionMetadata partitions = 2;
  bool internal = 3;
}

message PartitionMetadata {
  uint32 id = 1;
  uint32 leader = 2;
  repeated uint32 replicas = 3;
  repeated uint32 isr = 4;
}

message BrokerInfo {
  uint32 id = 1;
  string host = 2;
  uint32 port = 3;
  string rack = 4;
}

// Commit offset response
message CommitOffsetResponse {}

// Get offset response
message GetOffsetResponse {
  // Committed offset (-1 if not found)
  int64 offset = 1;
  string metadata = 2;
}

// Authenticate response
message AuthenticateResponse {
  // Session ID for authenticated session
  string session_id = 1;
  // Session expiry in seconds
  uint32 expires_in = 2;
  // For SCRAM: server challenge (base64 encoded)
  bytes server_response = 3;
}

// Ping response
message PingResponse {}

// Error response
message ErrorResponse {
  // Error code (see ErrorCode enum)
  int32 code = 1;
  // Human-readable error message
  string message = 2;
  // Detailed error info
  map<string, string> details = 3;
}

// OK response (generic success)
message OkResponse {}

// ============================================================================
// Extended Request Types
// ============================================================================

// Get cluster metadata (all topics or specific ones)
message GetClusterMetadataRequest {
  repeated string topics = 1;
}

// Get offset bounds for a partition
message GetOffsetBoundsRequest {
  string topic = 1;
  uint32 partition = 2;
}

// List consumer groups
message ListGroupsRequest {}

// Describe a consumer group
message DescribeGroupRequest {
  string consumer_group = 1;
}

// Delete a consumer group
message DeleteGroupRequest {
  string consumer_group = 1;
}

// Get offset for a timestamp
message GetOffsetForTimestampRequest {
  string topic = 1;
  uint32 partition = 2;
  int64 timestamp_ms = 3;
}

// Initialize idempotent producer
message InitProducerIdRequest {
  optional uint64 producer_id = 1;
}

// Idempotent publish
message IdempotentPublishRequest {
  string topic = 1;
  optional uint32 partition = 2;
  Record record = 3;
  uint64 producer_id = 4;
  uint32 producer_epoch = 5;
  int32 sequence = 6;
}

// Begin transaction
message BeginTransactionRequest {
  string txn_id = 1;
  uint64 producer_id = 2;
  uint32 producer_epoch = 3;
  optional uint64 timeout_ms = 4;
}

// Commit transaction
message CommitTransactionRequest {
  string txn_id = 1;
  uint64 producer_id = 2;
  uint32 producer_epoch = 3;
}

// Abort transaction
message AbortTransactionRequest {
  string txn_id = 1;
  uint64 producer_id = 2;
  uint32 producer_epoch = 3;
}

// Alter topic configuration
message AlterTopicConfigRequest {
  string topic = 1;
  repeated TopicConfigEntryProto configs = 2;
}

message TopicConfigEntryProto {
  string key = 1;
  optional string value = 2;
}

// Describe topic configurations
message DescribeTopicConfigsRequest {
  repeated string topics = 1;
}

// Create additional partitions
message CreatePartitionsRequest {
  string topic = 1;
  uint32 new_partition_count = 2;
}

// Delete records before offset
message DeleteRecordsRequest {
  string topic = 1;
  repeated PartitionOffset partition_offsets = 2;
}

message PartitionOffset {
  uint32 partition = 1;
  uint64 offset = 2;
}

// ============================================================================
// Extended Response Types
// ============================================================================

// Cluster metadata response
message GetClusterMetadataResponse {
  optional string controller_id = 1;
  repeated BrokerInfo brokers = 2;
  repeated TopicMetadata topics = 3;
}

// Offset bounds response
message GetOffsetBoundsResponse {
  uint64 earliest = 1;
  uint64 latest = 2;
}

// List groups response
message ListGroupsResponse {
  repeated string groups = 1;
}

// Describe group response
message DescribeGroupResponse {
  string consumer_group = 1;
  repeated GroupTopicOffsets topic_offsets = 2;
}

message GroupTopicOffsets {
  string topic = 1;
  repeated GroupPartitionOffset partition_offsets = 2;
}

message GroupPartitionOffset {
  uint32 partition = 1;
  uint64 offset = 2;
}

// Delete group response
message DeleteGroupResponse {}

// Offset for timestamp response
message GetOffsetForTimestampResponse {
  optional uint64 offset = 1;
}

// Init producer ID response
message InitProducerIdResponse {
  uint64 producer_id = 1;
  uint32 producer_epoch = 2;
}

// Idempotent publish response
message IdempotentPublishResponse {
  uint64 offset = 1;
  uint32 partition = 2;
  bool duplicate = 3;
}

// Begin transaction response
message BeginTransactionResponse {
  string txn_id = 1;
}

// Commit transaction response
message CommitTransactionResponse {
  string txn_id = 1;
}

// Abort transaction response
message AbortTransactionResponse {
  string txn_id = 1;
}

// Alter topic config response
message AlterTopicConfigResponse {
  string topic = 1;
  uint32 changed_count = 2;
}

// Describe topic configs response
message DescribeTopicConfigsResponse {
  repeated TopicConfigDescriptionProto configs = 1;
}

message TopicConfigDescriptionProto {
  string topic = 1;
  repeated TopicConfigValueProto entries = 2;
}

message TopicConfigValueProto {
  string key = 1;
  string value = 2;
  bool is_default = 3;
  bool is_read_only = 4;
  bool is_sensitive = 5;
}

// Create partitions response
message CreatePartitionsResponse {
  string topic = 1;
  uint32 new_partition_count = 2;
}

// Delete records response
message DeleteRecordsResponse {
  string topic = 1;
  repeated DeleteRecordsResultProto results = 2;
}

message DeleteRecordsResultProto {
  uint32 partition = 1;
  uint64 low_watermark = 2;
  string error = 3;
}

// ============================================================================
// SCRAM Messages
// ============================================================================

// SCRAM-SHA-256: Client-first message
message ScramClientFirstRequest {
  bytes message = 1;
}

// SCRAM-SHA-256: Client-final message
message ScramClientFinalRequest {
  bytes message = 1;
}

// SCRAM-SHA-256: Server-first (challenge)
message ScramServerFirstResponse {
  bytes message = 1;
}

// SCRAM-SHA-256: Server-final (verification)
message ScramServerFinalResponse {
  bytes message = 1;
  optional string session_id = 2;
  optional uint64 expires_in = 3;
}

// ============================================================================
// Transaction Extension Messages
// ============================================================================

// Transactional publish
message TransactionalPublishRequest {
  string txn_id = 1;
  string topic = 2;
  optional uint32 partition = 3;
  Record record = 4;
  uint64 producer_id = 5;
  uint32 producer_epoch = 6;
  int32 sequence = 7;
}

// Add partitions to transaction
message AddPartitionsToTxnRequest {
  string txn_id = 1;
  uint64 producer_id = 2;
  uint32 producer_epoch = 3;
  repeated TopicPartition partitions = 4;
}

message TopicPartition {
  string topic = 1;
  uint32 partition = 2;
}

// Add consumer offsets to transaction
message AddOffsetsToTxnRequest {
  string txn_id = 1;
  uint64 producer_id = 2;
  uint32 producer_epoch = 3;
  string group_id = 4;
  repeated TopicPartitionOffset offsets = 5;
}

message TopicPartitionOffset {
  string topic = 1;
  uint32 partition = 2;
  int64 offset = 3;
}

// Partitions added to transaction response
message PartitionsAddedToTxnResponse {
  string txn_id = 1;
  uint32 partition_count = 2;
}

// Transactional publish response
message TransactionalPublishResponse {
  uint64 offset = 1;
  uint32 partition = 2;
  int32 sequence = 3;
}

// Offsets added to transaction response
message OffsetsAddedToTxnResponse {
  string txn_id = 1;
}

// ============================================================================
// Quota Messages
// ============================================================================

// Describe quotas request
message DescribeQuotasRequest {
  repeated QuotaEntity entities = 1;
}

message QuotaEntity {
  string entity_type = 1;
  optional string entity_name = 2;
}

// Alter quotas request
message AlterQuotasRequest {
  repeated QuotaAlterationProto alterations = 1;
}

message QuotaAlterationProto {
  string entity_type = 1;
  optional string entity_name = 2;
  string quota_key = 3;
  optional uint64 quota_value = 4;
}

// Quotas described response
message QuotasDescribedResponse {
  repeated QuotaEntryProto entries = 1;
}

message QuotaEntryProto {
  string entity_type = 1;
  optional string entity_name = 2;
  map<string, uint64> quotas = 3;
}

// Quotas altered response
message QuotasAlteredResponse {
  uint32 altered_count = 1;
}

// Throttle response
message ThrottledResponse {
  uint64 throttle_time_ms = 1;
  string quota_type = 2;
  string entity = 3;
}

// ============================================================================
// Handshake Messages
// ============================================================================

// Protocol handshake request
message HandshakeRequest {
  uint32 protocol_version = 1;
  string client_id = 2;
}

// Protocol handshake response
message HandshakeResultResponse {
  uint32 server_version = 1;
  bool compatible = 2;
  string message = 3;
}

// ============================================================================
// Error Codes
// ============================================================================

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_UNKNOWN = 1;
  ERROR_CODE_INVALID_REQUEST = 2;
  ERROR_CODE_TOPIC_NOT_FOUND = 3;
  ERROR_CODE_PARTITION_NOT_FOUND = 4;
  ERROR_CODE_OFFSET_OUT_OF_RANGE = 5;
  ERROR_CODE_NOT_LEADER = 6;
  ERROR_CODE_BROKER_NOT_AVAILABLE = 7;
  ERROR_CODE_REPLICA_NOT_AVAILABLE = 8;
  ERROR_CODE_MESSAGE_TOO_LARGE = 9;
  ERROR_CODE_INVALID_TOPIC = 10;
  ERROR_CODE_INVALID_PARTITION = 11;
  ERROR_CODE_UNAUTHORIZED = 12;
  ERROR_CODE_TIMEOUT = 13;
  ERROR_CODE_QUOTA_EXCEEDED = 14;
}
