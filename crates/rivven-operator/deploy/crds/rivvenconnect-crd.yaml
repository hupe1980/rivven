# RivvenConnect CRD - Declarative Connector Management for Rivven
#
# Design: Generic config approach (like Kafka Connect)
# - Connector-specific configuration is a generic object
# - Validation happens at runtime by the controller
# - Connector schemas are documented separately, not in the CRD
# - Scales to 300+ connectors without CRD changes
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: rivvenconnects.rivven.hupe1980.github.io
  labels:
    app.kubernetes.io/name: rivven-operator
    app.kubernetes.io/component: crd
spec:
  group: rivven.hupe1980.github.io
  names:
    kind: RivvenConnect
    listKind: RivvenConnectList
    plural: rivvenconnects
    singular: rivvenconnect
    shortNames:
      - rconn
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Cluster
          type: string
          jsonPath: .spec.clusterRef.name
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Sources
          type: integer
          jsonPath: .status.sourcesRunning
        - name: Sinks
          type: integer
          jsonPath: .status.sinksRunning
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - clusterRef
              properties:
                # ================================================================
                # Cluster Reference
                # ================================================================
                clusterRef:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      description: Name of the RivvenCluster to connect to
                    namespace:
                      type: string
                      description: Namespace of the RivvenCluster (defaults to same namespace)

                # ================================================================
                # Deployment Configuration
                # ================================================================
                replicas:
                  type: integer
                  minimum: 1
                  maximum: 10
                  default: 1
                  description: Number of connect worker replicas
                version:
                  type: string
                  default: "0.0.1"
                image:
                  type: string
                  description: Custom container image (overrides version-based default)
                imagePullPolicy:
                  type: string
                  enum: ["Always", "IfNotPresent", "Never"]
                  default: "IfNotPresent"
                imagePullSecrets:
                  type: array
                  items:
                    type: string
                resources:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true

                # ================================================================
                # Connect Runtime Configuration
                # ================================================================
                config:
                  type: object
                  properties:
                    stateDir:
                      type: string
                      default: "/data/connect-state"
                    logLevel:
                      type: string
                      enum: ["trace", "debug", "info", "warn", "error"]
                      default: "info"

                # ================================================================
                # Source Connectors (Generic Config)
                # ================================================================
                sources:
                  type: array
                  maxItems: 100
                  description: Source connectors - read from external systems, publish to Rivven
                  items:
                    type: object
                    required:
                      - name
                      - connector
                      - topic
                    properties:
                      name:
                        type: string
                        description: Unique connector name
                        maxLength: 63
                      connector:
                        type: string
                        description: "Connector class/type (e.g., postgres-cdc, mysql-cdc, http, kafka, s3)"
                      topic:
                        type: string
                        description: Target topic to publish events to
                      topicRouting:
                        type: string
                        description: "Topic pattern with placeholders: {schema}, {table}, {database}"
                      enabled:
                        type: boolean
                        default: true
                      # Generic connector configuration - validated at runtime
                      config:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                        description: Connector-specific configuration (validated by controller)
                      # Secret reference for sensitive values
                      configSecretRef:
                        type: string
                        description: Secret containing sensitive config (merged with config)
                      # Topic auto-creation settings
                      topicConfig:
                        type: object
                        properties:
                          partitions:
                            type: integer
                            minimum: 1
                            maximum: 10000
                          replicationFactor:
                            type: integer
                            minimum: 1
                            maximum: 10
                          autoCreate:
                            type: boolean
                            default: true

                # ================================================================
                # Sink Connectors (Generic Config)
                # ================================================================
                sinks:
                  type: array
                  maxItems: 100
                  description: Sink connectors - consume from Rivven, write to external systems
                  items:
                    type: object
                    required:
                      - name
                      - connector
                      - topics
                      - consumerGroup
                    properties:
                      name:
                        type: string
                        description: Unique connector name
                        maxLength: 63
                      connector:
                        type: string
                        description: "Connector class/type (e.g., s3, iceberg, delta, http, snowflake)"
                      topics:
                        type: array
                        minItems: 1
                        maxItems: 1000
                        items:
                          type: string
                        description: "Topics to consume (supports wildcards: 'cdc.*')"
                      consumerGroup:
                        type: string
                        description: Consumer group for offset tracking
                      enabled:
                        type: boolean
                        default: true
                      startOffset:
                        type: string
                        enum: ["earliest", "latest"]
                        default: "latest"
                      # Generic connector configuration - validated at runtime
                      config:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                        description: Connector-specific configuration (validated by controller)
                      # Secret reference for sensitive values
                      configSecretRef:
                        type: string
                        description: Secret containing sensitive config (merged with config)
                      # Rate limiting
                      rateLimit:
                        type: object
                        properties:
                          eventsPerSecond:
                            type: integer
                            minimum: 0
                            default: 0
                            description: "Rate limit (0 = unlimited)"
                          burstCapacity:
                            type: integer
                            minimum: 0

                # ================================================================
                # Global Settings
                # ================================================================
                settings:
                  type: object
                  properties:
                    topic:
                      type: object
                      properties:
                        autoCreate:
                          type: boolean
                          default: true
                        defaultPartitions:
                          type: integer
                          minimum: 1
                          maximum: 10000
                          default: 1
                        defaultReplicationFactor:
                          type: integer
                          minimum: 1
                          maximum: 10
                          default: 1
                    retry:
                      type: object
                      properties:
                        maxRetries:
                          type: integer
                          minimum: 0
                          maximum: 100
                          default: 10
                        initialBackoffMs:
                          type: integer
                          minimum: 10
                          default: 100
                        maxBackoffMs:
                          type: integer
                          minimum: 100
                          default: 30000
                    health:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        port:
                          type: integer
                          minimum: 1024
                          maximum: 65535
                          default: 8080
                    metrics:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        port:
                          type: integer
                          minimum: 1024
                          maximum: 65535
                          default: 9091

                # ================================================================
                # TLS Configuration
                # ================================================================
                tls:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    certSecretName:
                      type: string
                    mtlsEnabled:
                      type: boolean
                      default: false
                    caSecretName:
                      type: string
                    insecure:
                      type: boolean
                      default: false

                # ================================================================
                # Pod Configuration
                # ================================================================
                podAnnotations:
                  type: object
                  additionalProperties:
                    type: string
                podLabels:
                  type: object
                  additionalProperties:
                    type: string
                env:
                  type: array
                  items:
                    type: object
                    x-kubernetes-preserve-unknown-fields: true
                nodeSelector:
                  type: object
                  additionalProperties:
                    type: string
                tolerations:
                  type: array
                  items:
                    type: object
                    x-kubernetes-preserve-unknown-fields: true
                affinity:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
                serviceAccount:
                  type: string
                securityContext:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
                containerSecurityContext:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true

            # ================================================================
            # Status
            # ================================================================
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Starting", "Running", "Degraded", "Failed", "Terminating"]
                replicas:
                  type: integer
                readyReplicas:
                  type: integer
                sourcesRunning:
                  type: integer
                sinksRunning:
                  type: integer
                sourcesTotal:
                  type: integer
                sinksTotal:
                  type: integer
                observedGeneration:
                  type: integer
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                connectorStatuses:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      connector:
                        type: string
                      kind:
                        type: string
                        enum: ["source", "sink"]
                      state:
                        type: string
                        enum: ["starting", "running", "paused", "failed", "stopped"]
                      eventsProcessed:
                        type: integer
                      bytesProcessed:
                        type: integer
                      lastError:
                        type: string
                      lastSuccessTime:
                        type: string
                      lag:
                        type: integer
                lastUpdated:
                  type: string
                message:
                  type: string
